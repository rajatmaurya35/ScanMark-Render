<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScanMark - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" />
    <script src="/static/js/buttons-fix.js" defer></script>

    <style>
        :root {
            --primary-color: #2ECC71;
            --secondary-color: #27AE60;
            --accent-color: #3498db;
            --background-color: #f8f9fa;
        }

        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(45deg, #2ECC71, #3498db);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0.7rem 1rem;
        }
        .logo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 3px;
            width: 24px;
            height: 24px;
        }
        .logo-square {
            background-color: #fff;
            border-radius: 3px;
            width: 100%;
            height: 100%;
        }
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            animation: fadeInUp 0.6s ease-out;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            animation: countUp 1s ease-out;
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-container {
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 1rem;
            font-weight: 500;
        }

        .btn {
            border-radius: 5px;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-control {
            border-radius: 5px;
            padding: 0.5rem;
            border: 1px solid #ddd;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: none;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            border-top: none;
            font-weight: 600;
        }

        .badge {
            padding: 0.5rem 0.75rem;
            border-radius: 5px;
        }

        .badge.bg-success {
            background-color: var(--primary-color) !important;
        }

        /* Fetched QR image (static) */
        #qrDisplayContainer img {
            width: 300px;
            height: 300px;
            border: 8px solid #004aad;
            border-radius: 12px;
            display: block;
            margin: 1rem auto;
        }

        #viewQRImage {
          display: block;
          margin: 0 auto;
        }
        #viewQRImage.flip {
          animation: flipAnim 1s ease-out;
        }
        @keyframes flipAnim {
          from { transform: perspective(400px) rotateY(0); }
          to   { transform: perspective(400px) rotateY(360deg); }
        }

        .card {
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
        }
        
        .alert-info {
            background-color: #e3f2fd;
            border-color: #90caf9;
            color: #1976d2;
            animation: slideIn 0.3s ease-out;
        }
        
        .alert-warning {
            background-color: #fff3e0;
            border-color: #ffe0b2;
            color: #f57c00;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-card {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .active-badge {
            background-color: #2ECC71;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .squares-logo {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            width: 60px;
            margin: 0 auto 15px;
        }

        .square {
            width: 25px;
            height: 25px;
            background: #2ECC71;
            border-radius: 5px;
            animation: pulse 2s infinite;
        }

        .square:nth-child(2) { animation-delay: 0.5s; }
        .square:nth-child(3) { animation-delay: 1s; }
        .square:nth-child(4) { animation-delay: 1.5s; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <div class="d-flex align-items-center">
                    <div class="logo-grid me-2">
                        <div class="logo-square"></div>
                        <div class="logo-square"></div>
                        <div class="logo-square"></div>
                        <div class="logo-square"></div>
                    </div>
                    <span>ScanMark Admin</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_logout') }}">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 py-5">
        <!-- Stats Row -->
        <div class="row g-3 mb-4">
            <div class="col-12 mb-2 d-flex justify-content-end">
                <button id="refreshDashboardBtn" class="btn btn-sm btn-outline-success" title="Refresh Dashboard">
                    <i class="fas fa-sync-alt me-1"></i> Refresh Dashboard
                </button>
            </div>
            <div class="col-md-3">
                <div class="card text-white h-100" style="background: linear-gradient(45deg, #1565C0, #1976D2);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-2">Total Sessions</h6>
                                <div class="stat-value" id="totalSessionsCount">{{ stats.total_sessions }}</div>
                            </div>
                            <i class="fas fa-chalkboard-teacher fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white h-100" style="background: linear-gradient(45deg, #00ACC1, #26C6DA);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-2">Total Attendance</h6>
                                <div id="totalAttendanceCount" class="stat-value">{{ stats.total_attendance }}</div>
                            </div>
                            <i class="fas fa-users fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white h-100" style="background: linear-gradient(45deg, #2E7D32, #43A047);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-2">Active Sessions</h6>
                                <div class="stat-value" id="activeSessionsCount">{{ stats.active_sessions }}</div>
                            </div>
                            <i class="fas fa-user-clock fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white h-100" style="background: linear-gradient(45deg, #F57C00, #FF9800);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-2">Total Students</h6>
                                <div class="stat-value" id="totalStudentsCount">{{ stats.total_students }}</div>
                            </div>
                            <i class="fas fa-user-graduate fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights and Risk Alerts in one row -->
        <div class="row mb-4">
            <!-- AI Insights -->
            <div class="col-md-4">
                <div class="card h-100 animate__animated animate__fadeIn">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Insights</h5>
                    </div>
                    <div class="card-body" id="aiInsights">
                        {% if ai_insights %}
                        <ul class="list-unstyled mb-0">
                            {% for insight in ai_insights %}
                            <li class="mb-2">
                                <i class="fas fa-lightbulb text-info me-2"></i>{{ insight }}
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>No insights available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Risk Alerts -->
            <div class="col-md-4">
                <div class="card h-100 animate__animated animate__fadeIn">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Risk Alerts</h5>
                    </div>
                    <div class="card-body" id="riskAlerts">
                        {% if risk_alerts %}
                        <ul class="list-unstyled mb-0">
                            {% for ra in risk_alerts %}
                            <li class="mb-2">
                                <i class="fas fa-circle text-warning me-2"></i>
                                <strong>{{ ra.subject }}</strong> - {{ ra.faculty }}
                                <span class="badge bg-warning text-dark ms-2">No Attendance</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted mb-0"><i class="fas fa-check-circle text-success me-2"></i>All active sessions have attendance</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
            </div>
        </div>

        <!-- Sessions Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card animate__animated animate__fadeIn">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Active Sessions</h5>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createSessionModal" id="createSessionBtn">
                            <i class="fas fa-plus me-1"></i> Create New Session
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filter Controls -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="sessionSearchInput" placeholder="Search sessions..." aria-label="Search sessions">
                                    <button class="btn btn-outline-secondary" type="button" id="sessionSearchBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex justify-content-end">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-success active" id="filterAllBtn">All</button>
                                    <button type="button" class="btn btn-outline-success" id="filterActiveBtn">Active</button>
                                    <button type="button" class="btn btn-outline-danger" id="filterInactiveBtn">Inactive</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Session</th>
                                        <th>Faculty</th>
                                        <th>Branch</th>
                                        <th>Semester</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sessionsTable">
                                </tbody>
                            </table>
                        </div>
                        <!-- No Results Message -->
                        <div id="noSessionsMessage" class="text-center py-3 d-none">
                            <p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>No sessions found matching your criteria</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Attendance List Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card animate__animated animate__fadeIn">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Student Attendance Lists</h5>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createAttendanceListModal">
                            <i class="fas fa-clipboard-list me-2"></i> Create Attendance List
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Session</th>
                                        <th>Students</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceListsTable">
                                    {% if attendance_lists %}
                                    {% for attendance_item in attendance_lists %}
                                    <tr>
                                        <td>{{ attendance_item.date }}</td>
                                        <td>{{ attendance_item.session }}</td>
                                        <td>{{ attendance_item.total_students }}</td>
                                        <td>{{ attendance_item.present }}</td>
                                        <td>{{ attendance_item.absent }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-primary" onclick="viewAttendanceList('{{ attendance_item.id }}')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="editAttendanceList('{{ attendance_item.id }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteAttendanceList('{{ attendance_item.id }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No attendance lists created yet</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Session Modal -->
        <div class="modal fade" id="createSessionModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Create New Session</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createSessionForm">
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subject" name="subject" placeholder="e.g. Physics" required>
                            </div>
                            <div class="mb-3">
                                <label for="faculty" class="form-label">Faculty <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="faculty" name="faculty" placeholder="e.g. Prof. Smith" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="branch" class="form-label">Branch <span class="text-danger">*</span></label>
                                    <select class="form-select" id="branch" name="branch" required>
                                        <option value="" selected disabled>Select Branch</option>
                                        <option value="IT">IT</option>
                                        <option value="Computer">Computer</option>
                                        <option value="Mechanical">Mechanical</option>
                                        <option value="Civil">Civil</option>
                                        <option value="Electrical">Electrical</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="semester" class="form-label">Semester <span class="text-danger">*</span></label>
                                    <select class="form-select" id="semester" name="semester" required>
                                        <option value="" selected disabled>Select Semester</option>
                                        <option value="1st sem">1st Semester</option>
                                        <option value="2nd sem">2nd Semester</option>
                                        <option value="3rd sem">3rd Semester</option>
                                        <option value="4th sem">4th Semester</option>
                                        <option value="5th sem">5th Semester</option>
                                        <option value="6th sem">6th Semester</option>
                                        <option value="7th sem">7th Semester</option>
                                        <option value="8th sem">8th Semester</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i>Create Session</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Modal -->
        <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>Session QR Code</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="qrCodeContainer" class="mb-3"></div>
                        <p id="qrSessionDetails" class="mb-2 text-muted"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <a href="#" id="downloadQrBtn" class="btn btn-success" download="qr-code.png">
                            <i class="fas fa-download me-1"></i> Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create Attendance List Modal -->
        <div class="modal fade" id="createAttendanceListModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-clipboard-list me-2"></i>Create Attendance List</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createAttendanceListForm">
                            <div class="mb-3">
                                <label for="sessionSelect" class="form-label">Select Session</label>
                                <select class="form-select" id="sessionSelect" required>
                                    <option value="" selected disabled>Choose a session</option>
                                    {% for session in sessions %}
                                    {% if session.status == 'active' %}
                                    <option value="{{ session.token }}">{{ session.session }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="attendanceDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="attendanceDate" required value="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                            <div class="mb-3">
                                <label for="attendanceNotes" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="attendanceNotes" rows="3" placeholder="Add any notes about this attendance list"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" id="createAttendanceListBtn">
                            <i class="fas fa-check-circle me-2"></i>Create List
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Attendance List Modal -->
        <div class="modal fade" id="viewAttendanceListModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Attendance List</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Session:</strong> <span id="attendanceListSession"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Date:</strong> <span id="attendanceListDate"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Total Students:</strong> <span id="attendanceListTotal"></span>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceListStudents">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success" id="saveAttendanceBtn">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Attendance List Modal -->
        <div class="modal fade" id="createAttendanceListModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-clipboard-list me-2"></i>Create Attendance List</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createAttendanceListForm">
                            <div class="mb-3">
                                <label for="attendanceSession" class="form-label">Select Session</label>
                                <select class="form-select" id="attendanceSession" required>
                                    <option value="" selected disabled>Choose a session</option>
                                    <!-- Sessions will be populated via JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="attendanceDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="attendanceDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="attendanceNotes" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="attendanceNotes" rows="3" placeholder="Add any notes about this attendance list"></textarea>
                            </div>
                            <div id="studentAttendanceSection" class="d-none">
                                <h6 class="border-bottom pb-2 mb-3">Student Attendance</h6>
                                <div id="studentAttendanceList">
                                    <!-- Students will be populated via JavaScript -->
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" id="createAttendanceListBtn">
                            <i class="fas fa-save me-1"></i> Create List
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View QR Modal -->
        <div class="modal fade" id="viewQRModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>Session QR Code</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <div class="squares-logo mb-3 mx-auto">
                  <div class="square"></div>
                  <div class="square"></div>
                  <div class="square"></div>
                  <div class="square"></div>
                </div>
                <h4 class="text-success mb-4">ScanMark QR</h4>
                <div class="qr-container mx-auto">
                  <img id="viewQRImage" src="" class="img-fluid mx-auto d-block" style="max-width:300px; border: 8px solid #2ECC71; border-radius: 12px;" />
                </div>
              </div>
              <div class="modal-footer justify-content-center">
                <a id="downloadBtn" class="btn btn-success" download>
                  <i class="fas fa-download me-1"></i>Download
                </a>
                <a id="openFormBtn" class="btn btn-primary text-white mx-2">
                  <i class="fas fa-external-link-alt me-1"></i>Open Form
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <!-- History Modal -->
        <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Attendance History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="table-responsive">
                  <table class="table" id="historyTable">
                    <thead>
                      <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Timestamp</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- SweetAlert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            // Add event listeners when the document is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize all buttons and ensure they work
                initializeButtons();
                
                // Update statistics and data
                updateStats();
                updateSessions();
                updateRiskAlerts();
                updateAiInsights();
                
                // Set up session creation form
                setupSessionForm();
            });
            
            // Initialize all buttons to ensure they work
            function initializeButtons() {
                // QR code buttons
                document.querySelectorAll('.btn-primary[onclick^="viewQR"]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const token = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                        viewQR(token);
                    });
                });
                
                // Manage buttons
                document.querySelectorAll('.btn-success[onclick^="viewAttendance"]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const token = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                        viewAttendance(token);
                    });
                });
                
                // Attendance buttons
                document.querySelectorAll('.btn-info[onclick^="createAttendanceListForSession"]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const token = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                        createAttendanceListForSession(token);
                    });
                });
                
                // Toggle buttons
                document.querySelectorAll('button[onclick^="toggleSession"]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const token = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                        toggleSession(token, this);
                    });
                });
                
                // Delete buttons
                document.querySelectorAll('.btn-danger[onclick^="deleteSession"]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const token = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                        deleteSession(token, this);
                    });
                });
            }
            
            async function toggleSession(token, btn) {
                try {
                    // Show loading indicator
                    const originalContent = btn ? btn.innerHTML : '';
                    if (btn) {
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                        btn.disabled = true;
                    }
                    
                    const res = await fetch(`/admin/toggle-session/${token}`, {
                        method: 'POST',
                        headers: {'X-Requested-With': 'XMLHttpRequest'}
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        // Restore button
                        if (btn) {
                            btn.innerHTML = originalContent;
                            btn.disabled = false;
                        }
                        
                        Swal.fire({
                            title: 'Success',
                            text: `Session status changed to ${data.status}`,
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                                // Refresh sessions
                        window.location.reload();
                    } else {
                        // Restore button
                        if (btn) {
                            btn.innerHTML = originalContent;
                            btn.disabled = false;
                        }
                        
                        Swal.fire('Error', data.error || 'Failed to toggle session status', 'error');
                    }
                } catch (error) {
                    console.error('Error toggling session:', error);
                    
                    // Restore button
                    if (btn) {
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    }
                    
                    Swal.fire('Error', 'Unable to toggle session status', 'error');
                }
            }

            // Function to update risk alerts dynamically
            async function updateRiskAlerts() {
                try {
                    const res = await fetch('/admin/get-risk-alerts', {headers: {'X-Requested-With': 'XMLHttpRequest'}});
                    const data = await res.json();
                    const container = document.getElementById('riskAlerts');
                    if(data.success) {
                        if(data.risk_alerts.length) {
                            let html = '<ul class="list-unstyled mb-0">';
                            data.risk_alerts.forEach(ra => {
                                html += `<li class="mb-2"><i class="fas fa-circle text-warning me-2"></i><strong>${ra.subject}</strong> - ${ra.faculty}<span class="badge bg-warning text-dark ms-2">No Attendance</span></li>`;
                            });
                            html += '</ul>';
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-check-circle text-success me-2"></i>All active sessions have attendance</p>';
                        }
                    }
                } catch(e) { console.error(e); }
            }
            // Fetch and render AI insights
            async function updateAiInsights() {
                try {
                    const res = await fetch('/admin/get-ai-insights', {headers: {'X-Requested-With': 'XMLHttpRequest'}});
                    const data = await res.json();
                    const container = document.getElementById('aiInsights');
                    if(data.success) {
                        if(data.ai_insights.length) {
                            let html = '<ul class="list-unstyled mb-0">';
                            data.ai_insights.forEach(ins => {
                                html += `<li class="mb-2"><i class="fas fa-lightbulb text-info me-2"></i>${ins}</li>`;
                            });
                            html += '</ul>';
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>No insights available</p>';
                        }
                    }
                } catch(e) { console.error(e); }
            }
            // Fetch and render Sessions table
            function updateSessions() {
                renderSessionsTable();
            }
            
            // Global variables for filtering and searching
            let currentFilter = 'all';
            let currentSearchTerm = '';
            
            // Initialize event listeners for search and filter
            document.addEventListener('DOMContentLoaded', function() {
                // Search functionality
                const searchInput = document.getElementById('sessionSearchInput');
                const searchBtn = document.getElementById('sessionSearchBtn');
                
                if (searchInput) {
                    searchInput.addEventListener('keyup', function(e) {
                        if (e.key === 'Enter') {
                            currentSearchTerm = searchInput.value.toLowerCase().trim();
                            renderSessionsTable();
                        }
                    });
                }
                
                if (searchBtn) {
                    searchBtn.addEventListener('click', function() {
                        currentSearchTerm = searchInput.value.toLowerCase().trim();
                        renderSessionsTable();
                    });
                }
                
                // Filter buttons
                const filterAllBtn = document.getElementById('filterAllBtn');
                const filterActiveBtn = document.getElementById('filterActiveBtn');
                const filterInactiveBtn = document.getElementById('filterInactiveBtn');
                
                if (filterAllBtn) {
                    filterAllBtn.addEventListener('click', function() {
                        setActiveFilter('all');
                        currentFilter = 'all';
                        renderSessionsTable();
                    });
                }
                
                if (filterActiveBtn) {
                    filterActiveBtn.addEventListener('click', function() {
                        setActiveFilter('active');
                        currentFilter = 'active';
                        renderSessionsTable();
                    });
                }
                
                if (filterInactiveBtn) {
                    filterInactiveBtn.addEventListener('click', function() {
                        setActiveFilter('inactive');
                        currentFilter = 'inactive';
                        renderSessionsTable();
                    });
                }
                
                // Refresh dashboard button
                const refreshDashboardBtn = document.getElementById('refreshDashboardBtn');
                if (refreshDashboardBtn) {
                    refreshDashboardBtn.addEventListener('click', function() {
                        refreshDashboard();
                    });
                }
            });
            
            // Function to refresh the dashboard data
            function refreshDashboard() {
                // Show loading indicator on the refresh button
                const refreshBtn = document.getElementById('refreshDashboardBtn');
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
                }
                
                // Fetch updated session data
                fetch('/admin/get-sessions')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Update sessions data
                            window.sessionsData = data.sessions;
                            
                            // Re-render the sessions table
                            renderSessionsTable();
                            
                            // Show success message
                            Swal.fire({
                                title: 'Dashboard Refreshed',
                                text: 'The dashboard has been updated with the latest data',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            throw new Error(data.error || 'Failed to refresh dashboard');
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing dashboard:', error);
                        Swal.fire('Error', 'Failed to refresh dashboard', 'error');
                    })
                    .finally(() => {
                        // Reset the refresh button
                        if (refreshBtn) {
                            refreshBtn.disabled = false;
                            refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh Dashboard';
                        }
                    });
            }
            
            // Helper function to set active filter button
            function setActiveFilter(filter) {
                document.getElementById('filterAllBtn').classList.remove('active');
                document.getElementById('filterActiveBtn').classList.remove('active');
                document.getElementById('filterInactiveBtn').classList.remove('active');
                
                if (filter === 'all') {
                    document.getElementById('filterAllBtn').classList.add('active');
                } else if (filter === 'active') {
                    document.getElementById('filterActiveBtn').classList.add('active');
                } else if (filter === 'inactive') {
                    document.getElementById('filterInactiveBtn').classList.add('active');
                }
            }
            
            // Render the sessions table with the current data
            function renderSessionsTable() {
                try {
                    const sessionsTable = document.querySelector('#sessionsTable');
                    const noSessionsMessage = document.getElementById('noSessionsMessage');
                    
                    if (!sessionsTable) {
                        console.error('Sessions table not found');
                        return;
                    }
                    
                    // Clear loading state
                    sessionsTable.innerHTML = '';
                    
                    // Use sessions data passed from Flask backend
                    if (typeof sessionsData === 'undefined') {
                        // Define sessionsData if not already defined
                        window.sessionsData = JSON.parse('{{ sessions|tojson }}');
                        console.log('Initialized sessions data:', window.sessionsData);
                    }
                    
                    if (!sessionsData || sessionsData.length === 0) {
                        // No sessions found
                        sessionsTable.innerHTML = '<tr><td colspan="6" class="text-center">No sessions found</td></tr>';
                        if (noSessionsMessage) noSessionsMessage.classList.add('d-none');
                        return;
                    }
                    
                    // Filter sessions based on current filter and search term
                    let filteredSessions = [...sessionsData];
                    
                    // Apply status filter
                    if (currentFilter === 'active') {
                        filteredSessions = filteredSessions.filter(s => s.status === 'active');
                    } else if (currentFilter === 'inactive') {
                        filteredSessions = filteredSessions.filter(s => s.status !== 'active');
                    }
                    
                    // Apply search term
                    if (currentSearchTerm) {
                        filteredSessions = filteredSessions.filter(s => 
                            s.subject.toLowerCase().includes(currentSearchTerm) ||
                            s.faculty.toLowerCase().includes(currentSearchTerm) ||
                            s.branch.toLowerCase().includes(currentSearchTerm) ||
                            s.semester.toLowerCase().includes(currentSearchTerm)
                        );
                    }
                    
                    // Sort sessions - active sessions first, then by subject
                    filteredSessions.sort((a, b) => {
                        if (a.status === 'active' && b.status !== 'active') return -1;
                        if (a.status !== 'active' && b.status === 'active') return 1;
                        return a.subject.localeCompare(b.subject);
                    });
                    
                    // Check if we have any sessions after filtering
                    if (filteredSessions.length === 0) {
                        if (noSessionsMessage) noSessionsMessage.classList.remove('d-none');
                        return;
                    } else {
                        if (noSessionsMessage) noSessionsMessage.classList.add('d-none');
                    }
                    
                    // Render each session
                    console.log('Filtered sessions:', filteredSessions);
                    for (let i = 0; i < filteredSessions.length; i++) {
                        const session = filteredSessions[i];
                        const row = document.createElement('tr');
                        
                        // Highlight active sessions
                        if (session.status === 'active') {
                            row.classList.add('table-success');
                        }
                        
                        // Add animation for newly added sessions
                        if (session.isNew) {
                            row.classList.add('animate__animated', 'animate__fadeIn');
                            // Remove the isNew flag after animation
                            setTimeout(() => { session.isNew = false; }, 1000);
                        }
                        
                        // Use the direct properties from the session object
                        const subject = session.subject || '';
                        const faculty = session.faculty || '';
                        const branch = session.branch || '';
                        const semester = session.semester || '';
                        
                        row.innerHTML = `
                            <td>${subject}</td>
                            <td>${faculty}</td>
                            <td>${branch}</td>
                            <td>${semester}</td>
                            <td>
                                <span class="badge ${session.status === 'active' ? 'bg-success' : 'bg-danger'}">
                                    ${session.status === 'active' ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    ${session.status === 'active' ? `
                                        <button class="btn btn-sm btn-success" onclick="viewQR('${session.token}')" title="View QR Code">
                                            <i class="fas fa-qrcode"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm ${session.status === 'active' ? 'btn-warning' : 'btn-primary'}" onclick="toggleSession('${session.token}')" title="${session.status === 'active' ? 'Deactivate' : 'Activate'} Session">
                                        <i class="fas fa-toggle-${session.status === 'active' ? 'on' : 'off'}"></i> 
                                        ${session.status === 'active' ? 'Deactivate' : 'Activate'}
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSession('${session.token}')" title="Delete Session">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        sessionsTable.appendChild(row);
                    }
                    
                    // Update stats
                    const activeCount = sessionsData.filter(s => s.status === 'active').length;
                    const totalCount = sessionsData.length;
                    
                    // Update stats if elements exist
                    const activeSessionsElement = document.getElementById('activeSessionsCount');
                    const totalSessionsElement = document.getElementById('totalSessionsCount');
                    
                    if (activeSessionsElement) activeSessionsElement.textContent = activeCount;
                    if (totalSessionsElement) totalSessionsElement.textContent = totalCount;
                    
                } catch (error) {
                    console.error('Error rendering sessions table:', error);
                    // Show error message
                    const sessionsTable = document.querySelector('#sessionsTable');
                    if (sessionsTable) {
                        sessionsTable.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading sessions</td></tr>`;
                    }
                }
            }
            
            window.viewQR = function(sessionToken) {
                console.log('Viewing QR for session:', sessionToken);
                
                // Get modal elements
                const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
                const qrContainer = document.getElementById('qrCodeContainer');
                const qrSessionDetails = document.getElementById('qrSessionDetails');
                
                // Clear previous QR code
                qrContainer.innerHTML = '';
                
                // Show loading
                qrContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"></div><p class="mt-2">Generating QR Code...</p></div>';
                
                // Show modal
                qrModal.show();
                
                // Fetch QR code
                fetch(`/admin/view-qr/${sessionToken}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('QR code response:', data);
                        
                        if (data.success) {
                            // Display QR code
                            qrContainer.innerHTML = `<img src="${data.qr_code}" class="img-fluid" alt="QR Code">`;
                            
                            // Set session details
                            qrSessionDetails.textContent = data.session;
                            
                            // Set download button
                            const downloadBtn = document.getElementById('downloadQrBtn');
                            if (downloadBtn) {
                                downloadBtn.href = data.qr_code;
                                downloadBtn.download = `qr_${sessionToken}.png`;
                            }
                        } else {
                            qrContainer.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to generate QR code'}</div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error generating QR code:', error);
                        qrContainer.innerHTML = '<div class="alert alert-danger">An unexpected error occurred</div>';
                    });
            };

            
            window.toggleSession = function(sessionToken) {
                console.log('Toggling session:', sessionToken);
                
                // Find the session in the sessionsData array
                const sessionIndex = sessionsData.findIndex(s => s.token === sessionToken);
                if (sessionIndex === -1) {
                    Swal.fire('Error', 'Session not found', 'error');
                    return;
                }
                
                const currentStatus = sessionsData[sessionIndex].status;
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                
                // Show loading indicator
                Swal.fire({
                    title: 'Processing...',
                    text: `${currentStatus === 'active' ? 'Deactivating' : 'Activating'} session`,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Send request to toggle session status
                fetch(`/admin/toggle-session/${sessionToken}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache' // Prevent caching
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Toggle response:', data);
                    
                    if (data.success) {
                        // Update the session in the local data
                        sessionsData[sessionIndex].status = data.status;
                        
                        // Show success message
                        Swal.fire({
                            title: 'Success',
                            text: `Session ${data.status === 'active' ? 'activated' : 'deactivated'} successfully`,
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Re-render the sessions table immediately
                        renderSessionsTable();
                    } else {
                        console.error('Failed to toggle session:', data.error);
                        Swal.fire('Error', data.error || 'Failed to toggle session status', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error toggling session:', error);
                    Swal.fire('Error', 'An unexpected error occurred while updating the session', 'error');
                });
            };

            
            window.deleteSession = function(sessionToken) {
                // Find the session in the sessionsData array
                const sessionIndex = sessionsData.findIndex(s => s.token === sessionToken);
                if (sessionIndex === -1) {
                    Swal.fire('Error', 'Session not found', 'error');
                    return;
                }
                
                const sessionName = sessionsData[sessionIndex].subject;
                
                Swal.fire({
                    title: 'Delete Session?',
                    text: `Are you sure you want to delete the session "${sessionName}"? This action cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        // Show loading indicator
                        Swal.fire({
                            title: 'Deleting...',
                            text: 'Please wait while the session is being deleted',
                            allowOutsideClick: false,
                            didOpen: () => { Swal.showLoading(); }
                        });
                        
                        try {
                            const res = await fetch(`/admin/delete-session/${sessionToken}`, {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (!res.ok) {
                                throw new Error(`Server responded with status: ${res.status}`);
                            }
                            
                            const data = await res.json();
                            
                            if (data.success) {
                                // Remove the session from the local data
                                sessionsData.splice(sessionIndex, 1);
                                
                                // Show success message
                                Swal.fire({
                                    title: 'Deleted!',
                                    text: 'Session has been deleted successfully.',
                                    icon: 'success',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                                
                                // Re-render the sessions table immediately
                                renderSessionsTable();
                            } else {
                                console.error('Failed to delete session:', data.error);
                                Swal.fire('Error', data.error || 'Failed to delete session', 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting session:', error);
                            Swal.fire('Error', 'An unexpected error occurred while deleting the session', 'error');
                        }
                    }
                });
            }
            
            window.viewAttendance = async function(sessionToken) {
                try {
                    const res = await fetch(`/admin/attendance-history/${sessionToken}`, {
                        headers: {'X-Requested-With': 'XMLHttpRequest'}
                    });
                    
                    const data = await res.json();
                    
                    const tbody = document.querySelector('#historyTable tbody');
                    tbody.innerHTML = '';
                    
                    if (Array.isArray(data) && data.length) {
                        data.forEach(r => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${r.student_id || ''}</td>
                                <td>${r.student_name || ''}</td>
                                <td>${new Date(r.created_at).toLocaleString()}</td>`;
                            tbody.appendChild(tr);
                        });
                    } else {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="3" class="text-center">No records</td>';
                        tbody.appendChild(tr);
                    }
                    
                    new bootstrap.Modal(document.getElementById('historyModal')).show();
                } catch (error) {
                    console.error('Error viewing attendance:', error);
                    Swal.fire('Error', 'Unable to fetch attendance history', 'error');
                }
            }
            
            // Function to create attendance list for a specific session
            function createAttendanceListForSession(token) {
                // Set the session in the dropdown
                const sessionSelect = document.getElementById('sessionSelect');
                if (sessionSelect) {
                    for (let i = 0; i < sessionSelect.options.length; i++) {
                        if (sessionSelect.options[i].value === token) {
                            sessionSelect.selectedIndex = i;
                            
                            // Trigger the change event to load students
                            const event = new Event('change');
                            sessionSelect.dispatchEvent(event);
                            
                            break;
                        }
                    }
                }
                
                // Set today's date
                const dateInput = document.getElementById('attendanceDate');
                if (dateInput) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dateInput.value = `${year}-${month}-${day}`;
                }
                
                // Show the modal
                new bootstrap.Modal(document.getElementById('createAttendanceListModal')).show();
            }
            
            // Function to update attendance lists
            async function updateAttendanceLists() {
                try {
                    const res = await fetch('/admin/get-attendance-lists', {
                        headers: {'X-Requested-With': 'XMLHttpRequest'}
                    });
                    
                    const data = await res.json();
                    
                    if (data.success) {
                        const tbody = document.getElementById('attendanceListsTable');
                        
                        if (data.lists.length > 0) {
                            let html = '';
                            
                            data.lists.forEach(attendanceItem => {
                                html += `
                                <tr>
                                    <td>${attendanceItem.date}</td>
                                    <td>${attendanceItem.session}</td>
                                    <td>${attendanceItem.total_students}</td>
                                    <td>${attendanceItem.present}</td>
                                    <td>${attendanceItem.absent}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="viewAttendanceList('${attendanceItem.id}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="editAttendanceList('${attendanceItem.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteAttendanceList('${attendanceItem.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>`;
                            });
                            
                            tbody.innerHTML = html;
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No attendance lists created yet</td></tr>';
                        }
                    }
                } catch (error) {
                    console.error('Error updating attendance lists:', error);
                }
            }
            
            // Function to view attendance list details
            function viewAttendanceList(listId) {
                console.log('Viewing attendance list:', listId);
                
                // Show loading indicator
                Swal.fire({
                    title: 'Loading...',
                    text: 'Fetching attendance details',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Fetch attendance list details
                fetch(`/admin/view-attendance-list/${listId}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Create a table of students
                        let studentsTable = '<table class="table table-sm table-striped">';
                        studentsTable += '<thead><tr><th>Student ID</th><th>Name</th><th>Status</th></tr></thead><tbody>';
                        
                        data.students.forEach(student => {
                            const statusClass = student.status === 'present' ? 'text-success' : 'text-danger';
                            const statusIcon = student.status === 'present' ? 'check-circle' : 'times-circle';
                            
                            studentsTable += `<tr>
                                <td>${student.id}</td>
                                <td>${student.name}</td>
                                <td><i class="fas fa-${statusIcon} ${statusClass}"></i> ${student.status}</td>
                            </tr>`;
                        });
                        
                        studentsTable += '</tbody></table>';
                        
                        // Show attendance details
                        Swal.fire({
                            title: `Attendance: ${data.session_name}`,
                            html: `
                                <div class="mb-3">
                                    <strong>Date:</strong> ${data.date}<br>
                                    <strong>Total:</strong> ${data.total_students} | 
                                    <strong>Present:</strong> ${data.present} | 
                                    <strong>Absent:</strong> ${data.absent}
                                </div>
                                <div class="attendance-students-list">
                                    ${studentsTable}
                                </div>
                            `,
                            width: 600,
                            showCloseButton: true,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire('Error', data.error || 'Failed to load attendance details', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error viewing attendance list:', error);
                    Swal.fire('Error', 'An unexpected error occurred while loading attendance details', 'error');
                });
            }
            
            // Function to edit attendance list
            function editAttendanceList(listId) {
                console.log('Editing attendance list:', listId);
                
                // Show loading indicator
                Swal.fire({
                    title: 'Loading...',
                    text: 'Fetching attendance data for editing',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Fetch attendance list details for editing
                fetch(`/admin/view-attendance-list/${listId}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Create form with student attendance status toggles
                        let studentsForm = '<form id="editAttendanceForm">';
                        
                        data.students.forEach(student => {
                            const checkedPresent = student.status === 'present' ? 'checked' : '';
                            const checkedAbsent = student.status !== 'present' ? 'checked' : '';
                            
                            studentsForm += `
                            <div class="mb-2 border-bottom pb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${student.name}</strong> (${student.id})
                                    </div>
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="status_${student.id}" id="present_${student.id}" value="present" ${checkedPresent}>
                                        <label class="btn btn-outline-success btn-sm" for="present_${student.id}">Present</label>
                                        
                                        <input type="radio" class="btn-check" name="status_${student.id}" id="absent_${student.id}" value="absent" ${checkedAbsent}>
                                        <label class="btn btn-outline-danger btn-sm" for="absent_${student.id}">Absent</label>
                                    </div>
                                </div>
                            </div>`;
                        });
                        
                        studentsForm += '</form>';
                        
                        // Show edit form
                        Swal.fire({
                            title: `Edit Attendance: ${data.session_name}`,
                            html: `
                                <div class="mb-3">
                                    <strong>Date:</strong> ${data.date}<br>
                                    <strong>Total Students:</strong> ${data.total_students}
                                </div>
                                <div class="attendance-edit-form">
                                    ${studentsForm}
                                </div>
                            `,
                            width: 600,
                            showCancelButton: true,
                            confirmButtonText: 'Save Changes',
                            cancelButtonText: 'Cancel',
                            showLoaderOnConfirm: true,
                            preConfirm: () => {
                                // Collect form data
                                const formData = {};
                                formData.list_id = listId;
                                formData.students = [];
                                
                                data.students.forEach(student => {
                                    const status = document.querySelector(`input[name="status_${student.id}"]:checked`).value;
                                    formData.students.push({
                                        id: student.id,
                                        status: status
                                    });
                                });
                                
                                // Send update request
                                return fetch('/admin/update-attendance-list', {
                                    method: 'POST',
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Server responded with status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (!data.success) {
                                        throw new Error(data.error || 'Failed to update attendance');
                                    }
                                    return data;
                                })
                                .catch(error => {
                                    Swal.showValidationMessage(`Request failed: ${error}`);
                                });
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire('Updated!', 'Attendance list has been updated.', 'success');
                                updateAttendanceLists(); // Refresh the attendance lists
                            }
                        });
                    } else {
                        Swal.fire('Error', data.error || 'Failed to load attendance details for editing', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error editing attendance list:', error);
                    Swal.fire('Error', 'An unexpected error occurred while loading attendance data', 'error');
                });
            }
            
            // Function to delete attendance list
            async function deleteAttendanceList(listId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const res = await fetch(`/admin/delete-attendance-list/${listId}`, {
                                method: 'DELETE',
                                headers: {'X-Requested-With': 'XMLHttpRequest'}
                            });
                            
                            const data = await res.json();
                            
                            if (data.success) {
                                Swal.fire('Deleted!', 'Attendance list has been deleted.', 'success');
                                updateAttendanceLists();
                            } else {
                                Swal.fire('Error', data.error || 'Failed to delete attendance list', 'error');
                            }
                        } catch (error) {
                            console.error('Error deleting attendance list:', error);
                            Swal.fire('Error', 'An error occurred while deleting the attendance list', 'error');
                        }
                    }
                });
            }
            
            // Function to view student location
            function viewStudentLocation(studentId) {
                // Placeholder for location viewing functionality
                Swal.fire({
                    title: 'Location Data',
                    html: `
                    <div id="studentLocationMap" style="height: 300px; width: 100%;"></div>
                    <p class="mt-2">Student ID: ${studentId}</p>
                    `,
                    width: 600,
                    showCloseButton: true,
                    showConfirmButton: false,
                    didOpen: () => {
                        // Initialize OpenStreetMap
                        const map = L.map('studentLocationMap').setView([23.0225, 72.5714], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);
                        
                        // Add marker for student location (placeholder coordinates)
                        L.marker([23.0225, 72.5714]).addTo(map)
                            .bindPopup(`Student ID: ${studentId}<br>Location recorded at: ${new Date().toLocaleString()}`);
                    }
                });
            }
        </script>

        <script>
            // Initialize all event handlers when the document is loaded
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Setting up create session form handler');
                
                // Get the create session form
                const createSessionForm = document.getElementById('createSessionForm');
                
                // Add submit event listener to the form
                if (createSessionForm) {
                    console.log('Found create session form, adding submit listener');
                    createSessionForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        console.log('Form submitted');
                        submitCreateSessionForm();
                    });
                } else {
                    console.error('Create session form not found');
                }
                
                // Setup attendance list creation
                setupCreateAttendanceList();
            });
            
            // Setup create attendance list functionality
            function setupCreateAttendanceList() {
                const attendanceSessionSelect = document.getElementById('attendanceSession');
                const createAttendanceListBtn = document.getElementById('createAttendanceListBtn');
                const attendanceDate = document.getElementById('attendanceDate');
                const studentAttendanceSection = document.getElementById('studentAttendanceSection');
                const studentAttendanceList = document.getElementById('studentAttendanceList');
                
                // Set today's date as default
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                if (attendanceDate) attendanceDate.value = formattedDate;
                
                // Populate sessions dropdown when modal is shown
                $('#createAttendanceListModal').on('show.bs.modal', async function() {
                    try {
                        // Clear previous data
                        if (attendanceSessionSelect) attendanceSessionSelect.innerHTML = '<option value="" selected disabled>Choose a session</option>';
                        if (studentAttendanceSection) studentAttendanceSection.classList.add('d-none');
                        if (studentAttendanceList) studentAttendanceList.innerHTML = '';
                        
                        // Fetch active sessions
                        const response = await fetch('/admin/get-sessions', {
                            method: 'GET',
                            headers: {'X-Requested-With': 'XMLHttpRequest'}
                        });
                        
                        const data = await response.json();
                        
                        if (data.success && data.sessions) {
                            // Filter only active sessions
                            const activeSessions = data.sessions.filter(s => s.status === 'active');
                            
                            // Add sessions to dropdown
                            activeSessions.forEach(session => {
                                const option = document.createElement('option');
                                option.value = session.token;
                                option.textContent = `${session.subject} - ${session.faculty} - ${session.branch} - ${session.semester}`;
                                attendanceSessionSelect.appendChild(option);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading sessions:', error);
                        Swal.fire('Error', 'Failed to load sessions', 'error');
                    }
                });
                
                // Load students when session is selected
                if (attendanceSessionSelect) {
                    attendanceSessionSelect.addEventListener('change', async function() {
                        const sessionId = this.value;
                        if (!sessionId) return;
                        
                        try {
                            // Show loading
                            studentAttendanceList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading students...</p></div>';
                            studentAttendanceSection.classList.remove('d-none');
                            
                            // For demo purposes, create sample students
                            const sampleStudents = [
                                { id: '211040107001', name: 'Fardin Bhai' },
                                { id: '211040107002', name: 'Ayush Pandey' },
                                { id: '211040107003', name: 'Shivam Kumar' },
                                { id: '211040107004', name: 'Raj Patel' },
                                { id: '211040107005', name: 'Priya Sharma' }
                            ];
                            
                            let html = '';
                            
                            // Generate student attendance controls
                            sampleStudents.forEach(student => {
                                html += `
                                <div class="mb-3 border-bottom pb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${student.name}</strong> (${student.id})
                                        </div>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="status_${student.id}" id="present_${student.id}" value="present" checked>
                                            <label class="btn btn-outline-success btn-sm" for="present_${student.id}">Present</label>
                                            
                                            <input type="radio" class="btn-check" name="status_${student.id}" id="absent_${student.id}" value="absent">
                                            <label class="btn btn-outline-danger btn-sm" for="absent_${student.id}">Absent</label>
                                        </div>
                                    </div>
                                </div>`;
                            });
                            
                            studentAttendanceList.innerHTML = html;
                        } catch (error) {
                            console.error('Error loading students:', error);
                            studentAttendanceList.innerHTML = '<div class="alert alert-danger">Error loading students</div>';
                        }
                    });
                }
                
                // Handle create attendance list button click
                if (createAttendanceListBtn) {
                    console.log('Adding click event to Create List button');
                    createAttendanceListBtn.addEventListener('click', async function() {
                        console.log('Create List button clicked');
                        // Validate form
                        const sessionId = attendanceSessionSelect.value;
                        const date = attendanceDate.value;
                        const notes = document.getElementById('attendanceNotes').value;
                        
                        console.log('Form data:', { sessionId, date, notes });
                        
                        if (!sessionId || !date) {
                            Swal.fire('Error', 'Please select a session and date', 'error');
                            return;
                        }
                        
                        // For demo purposes, create sample students with attendance
                        const students = {
                            '211040107001': 'present',
                            '211040107002': 'present',
                            '211040107003': 'absent',
                            '211040107004': 'present',
                            '211040107005': 'present'
                        };
                        
                        // Show loading
                        Swal.fire({
                            title: 'Creating attendance list...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        
                        try {
                            console.log('Submitting attendance data:', {
                                session_id: sessionId,
                                date: date,
                                notes: notes,
                                students: students
                            });
                            
                            // Submit data
                            const response = await fetch('/admin/create-attendance-list', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    session_id: sessionId,
                                    date: date,
                                    notes: notes,
                                    students: students
                                })
                            });
                            
                            console.log('Response received');
                            const data = await response.json();
                            console.log('Response data:', data);
                            
                            if (data.success) {
                                // Close modal and show success message
                                $('#createAttendanceListModal').modal('hide');
                                
                                Swal.fire({
                                    title: 'Success',
                                    text: 'Attendance list created successfully',
                                    icon: 'success',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                                
                                // Refresh attendance lists
                                updateAttendanceLists();
                            } else {
                                Swal.fire('Error', data.error || 'Failed to create attendance list', 'error');
                            }
                        } catch (error) {
                            console.error('Error creating attendance list:', error);
                            Swal.fire('Error', 'An unexpected error occurred', 'error');
                        }
                    });
                }
            }
            
            // Submit the create session form
            function submitCreateSessionForm() {
                console.log('Create session form submitted');
                
                // Get form data
                const formData = {
                    subject: document.getElementById('subject').value,
                    faculty: document.getElementById('faculty').value,
                    branch: document.getElementById('branch').value,
                    semester: document.getElementById('semester').value,
                    // Use current date and time
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toTimeString().split(' ')[0].substring(0, 5)
                };
                
                console.log('Form data:', formData);
                
                // Validate form
                if (!formData.subject || !formData.faculty || !formData.branch || !formData.semester) {
                    Swal.fire('Error', 'Please fill all required fields', 'error');
                    return;
                }
                
                // Show loading
                Swal.fire({
                    title: 'Creating session...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
                
                // Send request to create session
                fetch('/admin/create-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Create session response:', data);
                    
                    if (data.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('createSessionModal'));
                        if (modal) modal.hide();
                        
                        // Show success message
                        Swal.fire({
                            title: 'Success!',
                            text: 'Session created successfully',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Add the new session to the sessions data and refresh the table
                        if (data.session) {
                            // Create a new session object
                            const newSession = {
                                token: data.session.id,
                                session: `${data.session.subject} - ${data.session.faculty} - ${data.session.branch} - ${data.session.semester}`,
                                subject: data.session.subject,
                                faculty: data.session.faculty,
                                branch: data.session.branch,
                                semester: data.session.semester,
                                status: 'active',
                                isNew: true  // Mark as new for animation
                            };
                            
                            // Add to the beginning of the sessions array since it's active
                            if (typeof sessionsData !== 'undefined') {
                                sessionsData.unshift(newSession);
                                
                                // Reset filter to 'active' to ensure the new session is visible
                                currentFilter = 'active';
                                setActiveFilter('active');
                                
                                // Clear any search term
                                currentSearchTerm = '';
                                const searchInput = document.getElementById('sessionSearchInput');
                                if (searchInput) searchInput.value = '';
                                
                                // Render the table with the new session
                                renderSessionsTable();
                                
                                // Scroll to the top of the table to show the new session
                                const sessionsTable = document.querySelector('#sessionsTable');
                                if (sessionsTable) sessionsTable.scrollIntoView({ behavior: 'smooth' });
                            } else {
                                // If sessionsData is not available, reload the page
                                window.location.reload();
                            }
                        } else {
                            // If session data is not returned, just refresh the sessions
                            window.location.reload();
                        }
                        
                        // Reset form
                        document.getElementById('createSessionForm').reset();
                    } else {
                        Swal.fire('Error', data.error || 'Failed to create session', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error creating session:', error);
                    Swal.fire('Error', 'An unexpected error occurred', 'error');
                });
            }
        </script>

        <script>
            // Function to view attendance list
            function viewAttendanceList(listId) {
                window.location.href = '/admin/attendance-list/' + listId;
            }
        </script>
    </div>
</div>
</body>
</html>
